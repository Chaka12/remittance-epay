name: Build and Deploy to Netlify
on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.9'

      - name: Clean and prepare
        working-directory: flutter_app
        run: |
          # Clean any previous builds
          flutter clean
          
          # Create web directory if it doesn't exist
          mkdir -p web

      - name: Fix dependencies
        working-directory: flutter_app
        run: |
          # Create a clean pubspec for web build
          cp pubspec.yaml pubspec.yaml.backup
          
          # Use sed to create web-only version
          sed -i '/connectivity_plus/d' pubspec.yaml
          sed -i '/flutter_secure_storage/d' pubspec.yaml
          sed -i '/shared_preferences/d' pubspec.yaml
          sed -i '/path_provider/d' pubspec.yaml
          
          # Get dependencies
          flutter pub get

      - name: Generate localization files
        working-directory: flutter_app
        run: |
          # Generate intl files (skip if fails)
          flutter pub run intl_utils:generate || echo "intl_utils generation failed, continuing..."

      - name: Build for web
        working-directory: flutter_app
        run: |
          # Build with verbose output
          echo "Starting web build..."
          flutter build web --release --verbose 2>&1 | tail -50
          
          # Check if index.html was created
          echo "Checking build output..."
          ls -la build/web/
          
          if [ ! -f "build/web/index.html" ]; then
            echo "ERROR: index.html not found!"
            echo "Contents of build/web/:"
            ls -la build/web/
            exit 1
          fi

      - name: Upload build files
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: flutter_app/build/web/

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download build files
        uses: actions/download-artifact@v4
        with:
          name: web-build

      - name: Deploy to Netlify
        uses: nwtgck/actions-netlify@v3
        with:
          publish-dir: '.'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Deploy from GitHub Actions"
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
