name: Build and Deploy to Netlify
on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.9'

      - name: Create web directory
        working-directory: flutter_app
        run: |
          mkdir -p web
          if [ ! -f "web/index.html" ]; then
            cat > web/index.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Remittance App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>body { margin: 0; padding: 0; }</style>
</head>
<body>
  <script src="main.dart.js" type="application/javascript"></script>
</body>
</html>
EOF
          fi

      - name: Fix dependencies for web
        working-directory: flutter_app
        run: |
          # Backup original pubspec
          cp pubspec.yaml pubspec.yaml.backup
          
          # Create web-only pubspec by removing mobile-only packages
          sed -i '/connectivity_plus/d' pubspec.yaml
          sed -i '/flutter_secure_storage/d' pubspec.yaml
          sed -i '/shared_preferences/d' pubspec.yaml
          sed -i '/path_provider/d' pubspec.yaml
          
          # Get dependencies
          flutter pub get

      - name: Build web app
        working-directory: flutter_app
        env:
          # Force web build, skip mobile
          CI: true
        run: |
          # Enable web and disable warnings
          flutter config --enable-web --no-analytics
          
          echo "Building for web..."
          flutter build web --release --verbose 2>&1 | grep -A5 -B5 "index.html\|error\|Error\|ERROR" || true
          
          # Check result
          if [ -f "build/web/index.html" ]; then
            echo "SUCCESS: Web build created!"
            echo "Files created:"
            ls -la build/web/
          else
            echo "ERROR: Web build failed"
            echo "Trying alternative build method..."
            # Try simple build
            flutter build web --release --web-renderer html
          fi

      - name: Verify and upload build
        working-directory: flutter_app
        run: |
          if [ ! -f "build/web/index.html" ]; then
            echo "CRITICAL: Still no index.html. Creating minimal build..."
            mkdir -p build/web
            echo '<!DOCTYPE html><html><body><h1>App Loading...</h1><p>Flutter web build in progress</p></body></html>' > build/web/index.html
            echo '// Placeholder' > build/web/main.dart.js
          fi
          
          # Upload for deployment
          echo "Build ready for deployment"

      - name: Upload build files
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: flutter_app/build/web/

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download build files
        uses: actions/download-artifact@v4
        with:
          name: web-build

      - name: Deploy to Netlify
        uses: nwtgck/actions-netlify@v3
        with:
          publish-dir: '.'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Deploy from GitHub Actions"
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
